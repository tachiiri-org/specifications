{
  "spec_version": 1,
  "breaking_change": false,
  "effective_from": "2026-02-02",
  "boundary": "gateway_to_adapter",
  "deployment": {
    "gateway": "cloudflare_workers",
    "adapter": "cloudflare_workers"
  },
  "http": {
    "rpc_style": "operation_catalog_over_http",
    "routing": {
      "mode": "enabled",
      "base_path": "/adapter",
      "path_template": "/adapter/{service}/{resource}/{property}/{operation}",
      "segments": {
        "service": "string_non_empty",
        "resource": "string_non_empty",
        "property": "string_non_empty",
        "operation": "string_non_empty"
      }
    },
    "catalog": {
      "mode": "enabled",
      "operation_key_format": "{service}/{resource}/{property}/{operation}",
      "source": {
        "type": "spec_file",
        "path": "rules/operation_catalog.json"
      },
      "operation_selection": {
        "mode": "implemented_operations_only",
        "on_unimplemented": {
          "action": "reject",
          "status": 404,
          "error_code": "not_found"
        }
      }
    },
    "methods": {
      "allowed": [
        "POST",
        "OPTIONS"
      ],
      "state_changing": [
        "POST"
      ]
    },
    "content_types": {
      "accepted_request": [
        "application/json"
      ],
      "accepted_response": [
        "application/json"
      ],
      "require_json_on_methods": [
        "POST"
      ],
      "default_response": "application/json; charset=utf-8",
      "json_parsing": {
        "reject_invalid_json": true,
        "reject_bom": true,
        "reject_non_utf8": true
      }
    },
    "cache": {
      "response_cache_control": "no-store"
    },
    "csrf": {
      "mode": "disabled"
    },
    "contract_version": {
      "mode": "required",
      "header": "x-contract-version",
      "accepted": {
        "mode": "explicit_list",
        "items": [
          "1"
        ]
      },
      "on_missing": {
        "action": "reject",
        "status": 400,
        "error_code": "contract_version_required"
      }
    },
    "idempotency": {
      "mode": "enabled",
      "owner": "adapter",
      "require_key": {
        "apply_to_methods": [
          "POST"
        ],
        "require_header_on_route_operations": [
          "billing/invoice/core/create"
        ],
        "missing_key": {
          "action": "reject",
          "status": 400,
          "error_code": "idempotency_key_required"
        }
      },
      "csrf_check": {
        "mode": "disabled"
      },
      "fingerprint": {
        "include": [
          "claims.tenant_id",
          "claims.actor.actor_id",
          "route.service",
          "route.resource",
          "route.property",
          "route.operation",
          "x-idempotency-key",
          "body_hash"
        ],
        "body_hash": {
          "algorithm": "sha256",
          "input": {
            "type": "request_body",
            "encoding": {
              "type": "canonical_json",
              "rules": {
                "object_member_order": "sort_keys",
                "omit_insignificant_whitespace": true,
                "string_encoding": "utf-8",
                "number_representation": "normalized_json_number",
                "array_order": "preserve"
              }
            }
          },
          "only_for_content_types": [
            "application/json"
          ],
          "on_other_content_types": {
            "type": "raw_bytes"
          },
          "max_body_bytes_to_hash": 10485760,
          "on_body_too_large": {
            "action": "reject",
            "status": 413,
            "error_code": "idempotency_body_too_large_to_hash"
          }
        }
      },
      "inflight_lock": {
        "mode": "per_idempotency_key_scope",
        "scope_fields": [
          "claims.tenant_id",
          "claims.actor.actor_id",
          "route.service",
          "route.resource",
          "route.property",
          "route.operation",
          "x-idempotency-key"
        ],
        "status_on_lock_conflict": 202,
        "headers_on_lock_conflict": {
          "x-idempotency-state": "inflight"
        }
      },
      "conflict_rule": {
        "same_key_different_fingerprint": {
          "action": "reject",
          "status": 409,
          "error_code": "idempotency_key_conflict"
        }
      },
      "response_replay": {
        "on_duplicate_after_success": {
          "action": "return_stored_response",
          "return": {
            "status_source": "stored_response_status",
            "body": {
              "mode": "stored_inline_if_present",
              "on_missing": "empty"
            },
            "headers": {
              "mode": "stored_subset_if_present",
              "on_missing": "empty"
            }
          },
          "add_headers_on_replay": {
            "x-idempotency-replayed": "true"
          }
        },
        "on_duplicate_while_inflight": {
          "action": "wait_up_to_ms_then_return",
          "wait_up_to_ms": 2000,
          "on_timeout": {
            "status": 202,
            "error_code": "idempotency_inflight",
            "headers": {
              "retry-after": "2",
              "x-idempotency-state": "inflight_timeout"
            }
          }
        },
        "response_headers_subset_allowlist": [
          "content-type",
          "location",
          "etag",
          "cache-control",
          "x-request-id"
        ],
        "store_headers_subset_policy": "allowlist_only"
      },
      "storage": {
        "type": "durable_object",
        "backend": {
          "type": "sqlite"
        },
        "primary_key": "idempotency_fingerprint",
        "secondary_lookup": {
          "name": "idempotency_key_scope",
          "unique_key_fields": [
            "claims_tenant_id",
            "claims_actor_id",
            "route_service",
            "route_resource",
            "route_property",
            "route_operation",
            "idempotency_key"
          ]
        },
        "ttl": {
          "days": 1,
          "eviction": "allow_reuse_after_expiry_by_treating_as_new"
        },
        "record": {
          "fields": [
            "idempotency_fingerprint",
            "claims_tenant_id",
            "claims_actor_id",
            "route_service",
            "route_resource",
            "route_property",
            "route_operation",
            "idempotency_key",
            "request_body_hash",
            "request_headers_hash_optional",
            "status",
            "created_at",
            "expires_at",
            "response_status",
            "response_body_inline_optional",
            "response_headers_subset_optional"
          ],
          "status_enum": [
            "inflight",
            "succeeded",
            "failed"
          ],
          "response_body": {
            "mode": "inline_small_only",
            "max_inline_bytes": 16384,
            "on_exceed": "omit_body_and_store_status_only"
          },
          "garbage_collection": {
            "mode": "lazy_delete"
          }
        }
      }
    },
    "retry": {
      "mode": "enabled",
      "apply_to_methods": [
        "POST"
      ],
      "max_attempts": 2,
      "retry_on_status": [
        502,
        503,
        504
      ],
      "retry_on_network_error": true,
      "backoff_ms": [
        0,
        100
      ],
      "retry_gate": {
        "require_idempotency_key_when_state_changing": true
      }
    },
    "errors": {
      "defaults": {
        "default_status": 502
      },
      "propagation": {
        "always_use_error_shape": true,
        "algorithm": "preserve_then_map_then_shape",
        "preserve_status_for": [
          400,
          401,
          403,
          404,
          409,
          413,
          415,
          422,
          429,
          431,
          503
        ],
        "map_4xx_to": 502,
        "map_5xx_to": 502,
        "network_error_to": 502
      }
    },
    "timeouts": {
      "upstream_timeout_ms": 1700
    }
  },
  "auth": {
    "transport": "bearer",
    "require_authorization_header": true,
    "allow_cookie": false,
    "token_profile": {
      "type": "jwt",
      "allowed_algs": [
        "RS256"
      ],
      "issuer": "bff",
      "audience": "adapter",
      "jwks": {
        "source": "env",
        "env_var": "JWT_JWKS_JSON",
        "cache_ttl_sec": 300
      },
      "max_clock_skew_sec": 30,
      "required_claims": [
        "iss",
        "aud",
        "exp",
        "sub",
        "tenant_id",
        "actor.actor_id",
        "scopes",
        "roles"
      ]
    },
    "gateway_inbound": {
      "authorization_header": "authorization",
      "checks": [
        "verify_signature",
        "verify_issuer",
        "verify_audience",
        "verify_expiration",
        "verify_scopes_roles_as_needed"
      ],
      "on_fail": {
        "action": "reject",
        "status": 401,
        "error_code": "unauthorized"
      }
    },
    "gateway_outbound_to_adapter": {
      "mode": "bearer_passthrough",
      "authorization_header": "authorization",
      "passthrough": {
        "mode": "conditional",
        "condition": "only_if_downstream_requires"
      }
    }
  },
  "headers": {
    "pipeline_order": [
      "normalize",
      "drop_hop_by_hop",
      "explicit_drop",
      "allow",
      "default_drop"
    ],
    "normalize": {
      "mode": "lowercase"
    },
    "duplicates": {
      "mode": "reject",
      "reject_status": 400,
      "allow_multiple": [
        "set-cookie"
      ]
    },
    "drop_default": {
      "mode": "allowlist",
      "if_not_in_allow_or_passthrough": "drop"
    },
    "drop_hop_by_hop": [
      "connection",
      "keep-alive",
      "proxy-authenticate",
      "proxy-authorization",
      "te",
      "trailer",
      "transfer-encoding",
      "upgrade"
    ],
    "requirements": {
      "inbound_must_include": [
        "x-contract-version",
        "x-request-id"
      ],
      "outbound_must_include": [
        "x-contract-version",
        "x-request-id"
      ]
    },
    "gateway_outbound": {
      "drop": [
        "set-cookie",
        "cookie",
        "origin",
        "referer",
        "user-agent",
        "x-forwarded-for",
        "x-real-ip",
        "cf-connecting-ip",
        "cf-ray",
        "x-amzn-trace-id",
        "forwarded"
      ],
      "allow": [
        "content-type",
        "authorization",
        "traceparent",
        "x-contract-version",
        "x-request-id",
        "x-trace-debug",
        "x-idempotency-key"
      ]
    },
    "adapter_inbound": {
      "drop": [
        "cookie",
        "origin",
        "referer",
        "user-agent",
        "x-forwarded-for",
        "x-real-ip",
        "cf-connecting-ip",
        "cf-ray",
        "x-amzn-trace-id",
        "forwarded"
      ],
      "allow": [
        "content-type",
        "authorization",
        "traceparent",
        "x-request-id",
        "x-idempotency-key",
        "x-trace-debug",
        "x-contract-version"
      ],
      "forbidden_identity_headers": [
        "x-actor",
        "x-actor-sig",
        "x-actor-sub",
        "x-actor-provider",
        "x-actor-tenant-id",
        "x-actor-roles",
        "x-actor-scopes"
      ]
    }
  },
  "observability": {
    "mode": "enabled",
    "error_classification": {
      "mode": "enabled",
      "log_only": true,
      "required_fields": [
        "error_class",
        "fault_domain"
      ],
      "allowed_error_class": [
        "validation",
        "authn",
        "authz",
        "timeout",
        "upstream",
        "network",
        "bug",
        "overload"
      ],
      "allowed_fault_domain": [
        "front",
        "bff",
        "gateway",
        "adapter",
        "external"
      ]
    },
    "events": [
      "idempotency_conflict",
      "idempotency_replayed",
      "rate_limited",
      "upstream_error",
      "authz_denied"
    ],
    "log_fields": {
      "required_additional_fields": [
        "service",
        "resource",
        "property",
        "operation"
      ],
      "optional_additional_fields": [
        "idempotency_key_present",
        "idempotency_replayed",
        "upstream_target",
        "upstream_status"
      ]
    },
    "request_id": {
      "header": "x-request-id",
      "requirement_timing": "pre_processing",
      "generation": {
        "mode": "disabled"
      },
      "propagation": {
        "passthrough": true,
        "outbound_must_include": true
      }
    },
    "trace_context": {
      "traceparent": {
        "header": "traceparent",
        "propagation": "passthrough",
        "generate_if_missing": false
      }
    },
    "redaction": {
      "drop_headers": [
        "authorization",
        "cookie",
        "set-cookie"
      ],
      "redact_headers": [
        "x-idempotency-key"
      ],
      "redact_fields": [
        "email",
        "display_name"
      ],
      "redact_strategy": {
        "default": "hash",
        "hash_algorithm": "sha256",
        "salt_source": "deployment_secret"
      }
    },
    "sampling": {
      "logging": {
        "default_sample_rate": 1,
        "error_sample_rate": 1
      },
      "tracing": {
        "default_sample_rate": 0.1,
        "error_sample_rate": 1,
        "force_sample_if_header_present": "x-trace-debug"
      }
    }
  },
  "limits": {
    "header": {
      "max_request_header_bytes": 16384,
      "on_exceed": {
        "action": "reject",
        "status": 431,
        "error_code": "request_header_fields_too_large"
      }
    },
    "body": {
      "max_request_body_bytes": 10485760,
      "max_response_body_bytes": 5242880,
      "on_exceed": {
        "action": "reject",
        "status": 413,
        "error_code": "payload_too_large"
      }
    },
    "concurrency": {
      "max_concurrency": 8,
      "scope": "per_instance",
      "queueing": {
        "enabled": true,
        "max_queue_length": 256,
        "on_exceed": {
          "action": "reject",
          "status": 503,
          "error_code": "server_overloaded"
        }
      }
    },
    "rate_limit": {
      "mode": "enabled",
      "owner": "gateway",
      "status": 429,
      "error_code": "rate_limited",
      "algorithm": "token_bucket",
      "scopes": [
        {
          "name": "per_tenant_actor_operation",
          "key_fields": [
            "claims.tenant_id",
            "claims.actor.actor_id",
            "route.service",
            "route.resource",
            "route.property",
            "route.operation"
          ],
          "bucket": {
            "capacity": 60,
            "refill_per_second": 1
          },
          "on_exceed": {
            "action": "reject",
            "retry_after_seconds": 2
          }
        }
      ],
      "observability": {
        "on_exceed": {
          "error_class": "overload",
          "fault_domain": "gateway",
          "emit_event": "rate_limited",
          "log_fields": [
            "tenant_id",
            "actor_id",
            "service",
            "resource",
            "property",
            "operation"
          ]
        }
      }
    }
  },
  "authz": {
    "mode": "operation_based",
    "pdp": "adapter",
    "pep": [
      "gateway",
      "adapter"
    ],
    "decision_context": {
      "operation_source": "route.operation",
      "identity_source": "verified_token_claims_only",
      "claims_mapping": {
        "tenant_id": "claims.tenant_id",
        "actor_id": "claims.actor.actor_id",
        "scopes": "claims.scopes",
        "roles": "claims.roles"
      }
    },
    "policy_source": {
      "type": "operation_catalog",
      "operation_key_format": "{service}/{resource}/{property}/{operation}"
    },
    "catalog_binding": {
      "mode": "required",
      "source": "rules/operation_catalog.json"
    },
    "evaluation": {
      "scope_mode": "all_of",
      "role_mode": "any_of",
      "default_when_missing_policy": "deny"
    },
    "on_denied": {
      "status": 403,
      "error_code": "forbidden"
    },
    "enforcement": {
      "gateway_generates_deny_response": false,
      "gateway_on_upstream_403": "preserve"
    },
    "observability": {
      "on_denied": {
        "error_class": "authz",
        "emit_event": "authz_denied",
        "log_fields": [
          "tenant_id",
          "actor_id",
          "service",
          "resource",
          "property",
          "operation",
          "authz_result"
        ]
      }
    }
  }
}