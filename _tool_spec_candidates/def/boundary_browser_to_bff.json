{
  "spec_version": 1,
  "breaking_change": false,
  "effective_from": "2026-02-02",
  "boundary": "browser_to_bff",
  "deployment": {
    "front": "cloudflare_pages_and_functions",
    "bff": "cloudflare_workers"
  },
  "http": {
    "methods": {
      "allowed": [
        "GET",
        "POST",
        "PUT",
        "PATCH",
        "DELETE",
        "OPTIONS"
      ],
      "state_changing": [
        "POST",
        "PUT",
        "PATCH",
        "DELETE"
      ]
    },
    "content_types": {
      "accepted_request": [
        "application/json"
      ],
      "accepted_response": [
        "application/json"
      ],
      "require_json_on_methods": [
        "POST",
        "PUT",
        "PATCH",
        "DELETE"
      ],
      "default_response": "application/json; charset=utf-8",
      "json_parsing": {
        "reject_invalid_json": true,
        "reject_bom": true,
        "reject_non_utf8": true
      }
    },
    "cache": {
      "response_cache_control": "no-store",
      "vary": [
        "origin"
      ]
    },
    "csrf": {
      "mode": "enabled",
      "applied_methods": [
        "POST",
        "PUT",
        "PATCH",
        "DELETE"
      ],
      "mode_detail": "origin_check_and_token",
      "origin": {
        "allowed_origin": {
          "mode": "same_origin_only"
        },
        "missing_origin": "deny"
      },
      "session": {
        "require_session_cookie": true,
        "session_cookie_name": "__Host-session",
        "enforce_same_site_cookie": true
      },
      "token": {
        "strategy": "double_submit_cookie",
        "header_name": "x-csrf-token",
        "cookie_name": "__Host-csrf",
        "validate": {
          "require_header": true,
          "require_cookie": true,
          "match_header_and_cookie": true,
          "compare": "constant_time"
        }
      },
      "on_fail": {
        "action": "reject",
        "status": 403,
        "error_code": "csrf_forbidden"
      }
    },
    "idempotency": {
      "mode": "validate_only",
      "validate_only": {
        "require_header_when_state_changing": true,
        "on_missing_key": {
          "action": "reject",
          "status": 400,
          "error_code": "idempotency_key_required"
        }
      }
    },
    "retry": {
      "mode": "disabled"
    },
    "errors": {
      "defaults": {
        "default_status": 502
      },
      "propagation": {
        "always_use_error_shape": true,
        "algorithm": "preserve_then_map_then_shape",
        "preserve_status_for": [
          400,
          401,
          403,
          404,
          409,
          413,
          415,
          422,
          429,
          431,
          503
        ],
        "map_4xx_to": 502,
        "map_5xx_to": 502,
        "network_error_to": 502
      }
    },
    "timeouts": {
      "upstream_timeout_ms": 8000,
      "client_timeout_ms": 10000
    }
  },
  "cors": {
    "allow_credentials": {
      "mode": "enabled"
    },
    "allowed_origin": {
      "mode": "same_origin_only"
    },
    "allowed_methods": {
      "mode": "explicit_list",
      "items": [
        "GET",
        "POST",
        "PUT",
        "PATCH",
        "DELETE",
        "OPTIONS"
      ]
    },
    "allowed_headers": {
      "mode": "explicit_list",
      "items": [
        "content-type",
        "x-csrf-token",
        "x-idempotency-key",
        "traceparent",
        "x-trace-debug"
      ]
    },
    "exposed_headers": {
      "mode": "explicit_list",
      "items": [
        "x-request-id"
      ]
    },
    "vary": {
      "mode": "explicit_list",
      "items": [
        "origin",
        "access-control-request-method",
        "access-control-request-headers"
      ]
    },
    "max_age_seconds": {
      "prod": 86400,
      "stg_dev": 600
    }
  },
  "auth": {
    "transport": "cookie_session",
    "allow_cookie": true,
    "allow_authorization_header": false
  },
  "cookies": {
    "set_rules": {
      "allowed_emitters": [
        "bff"
      ],
      "allowed_to_browser_only": true,
      "forbid_downstream_propagation": true
    },
    "session_cookie": {
      "name": "__Host-session",
      "purpose": "browser_session",
      "policy": {
        "secure": true,
        "http_only": true,
        "same_site": "lax",
        "path": "/",
        "host_prefix_required": true,
        "domain_attribute": "forbidden",
        "max_age_seconds": 86400,
        "set_expires": true,
        "expires_from": "max_age"
      }
    },
    "csrf_cookie": {
      "name": "__Host-csrf",
      "purpose": "csrf_double_submit",
      "policy": {
        "secure": true,
        "http_only": false,
        "same_site": "lax",
        "path": "/",
        "host_prefix_required": true,
        "domain_attribute": "forbidden",
        "max_age_seconds": 86400,
        "set_expires": true,
        "expires_from": "max_age"
      }
    }
  },
  "headers": {
    "pipeline_order": [
      "normalize",
      "drop_hop_by_hop",
      "explicit_drop",
      "allow",
      "default_drop"
    ],
    "normalize": {
      "mode": "lowercase"
    },
    "duplicates": {
      "mode": "reject",
      "reject_status": 400,
      "allow_multiple": [
        "set-cookie"
      ]
    },
    "drop_default": {
      "mode": "allowlist",
      "if_not_in_allow_or_passthrough": "drop"
    },
    "drop_hop_by_hop": [
      "connection",
      "keep-alive",
      "proxy-authenticate",
      "proxy-authorization",
      "te",
      "trailer",
      "transfer-encoding",
      "upgrade"
    ],
    "inbound": {
      "drop": [
        "authorization",
        "x-forwarded-for",
        "x-real-ip",
        "cf-connecting-ip",
        "cf-ray",
        "x-request-id",
        "x-amzn-trace-id",
        "forwarded"
      ],
      "allow": [
        "accept",
        "accept-language",
        "content-type",
        "origin",
        "cookie",
        "traceparent",
        "x-trace-debug",
        "user-agent",
        "x-idempotency-key",
        "x-csrf-token"
      ],
      "authn": {
        "reject_browser_authorization_header": true
      }
    },
    "outbound": {
      "drop": [],
      "allow": [
        "content-type",
        "cache-control",
        "x-content-type-options",
        "referrer-policy",
        "x-request-id",
        "set-cookie"
      ],
      "security_headers_overwrite": {
        "overwrite": true,
        "set": {
          "cache-control": "no-store",
          "x-content-type-options": "nosniff",
          "referrer-policy": "no-referrer",
          "strict-transport-security": "max-age=31536000; includeSubDomains",
          "content-security-policy": "default-src 'self'; base-uri 'self'; object-src 'none'; frame-ancestors 'none'; form-action 'self'",
          "permissions-policy": "geolocation=(), microphone=(), camera=()",
          "cross-origin-opener-policy": "same-origin",
          "cross-origin-resource-policy": "same-origin"
        }
      }
    }
  },
  "observability": {
    "mode": "enabled",
    "error_classification": {
      "mode": "enabled",
      "log_only": true,
      "required_fields": [
        "error_class",
        "fault_domain"
      ],
      "allowed_error_class": [
        "validation",
        "authn",
        "authz",
        "timeout",
        "upstream",
        "network",
        "bug",
        "overload"
      ],
      "allowed_fault_domain": [
        "front",
        "bff",
        "gateway",
        "adapter",
        "external"
      ]
    },
    "events": [
      "csrf_rejected",
      "rate_limited"
    ],
    "request_id": {
      "header": "x-request-id",
      "requirement_timing": "post_processing",
      "generation": {
        "generate_if_missing_at": [
          "bff"
        ],
        "overwrite_at": [
          "bff"
        ]
      },
      "propagation": {
        "inbound_accept_from": {
          "mode": "none"
        },
        "outbound_must_include": true
      }
    },
    "trace_context": {
      "traceparent": {
        "header": "traceparent",
        "propagation": "passthrough",
        "generate_if_missing": false
      }
    },
    "log_schema": {
      "required_fields": [
        "timestamp",
        "level",
        "component",
        "request_id",
        "method",
        "route",
        "status",
        "latency_ms"
      ],
      "optional_fields": [
        "traceparent"
      ]
    },
    "redaction": {
      "drop_headers": [
        "authorization",
        "cookie",
        "set-cookie"
      ],
      "redact_headers": [
        "x-idempotency-key"
      ],
      "redact_fields": [
        "email",
        "display_name"
      ],
      "redact_strategy": {
        "default": "hash",
        "hash_algorithm": "sha256",
        "salt_source": "deployment_secret"
      }
    },
    "sampling": {
      "logging": {
        "default_sample_rate": 1,
        "error_sample_rate": 1
      },
      "tracing": {
        "default_sample_rate": 0.1,
        "error_sample_rate": 1,
        "force_sample_if_header_present": "x-trace-debug"
      }
    }
  },
  "limits": {
    "header": {
      "max_request_header_bytes": 16384,
      "on_exceed": {
        "action": "reject",
        "status": 431,
        "error_code": "request_header_fields_too_large"
      }
    },
    "body": {
      "max_request_body_bytes": 10485760,
      "max_response_body_bytes": 5242880,
      "on_exceed": {
        "action": "reject",
        "status": 413,
        "error_code": "payload_too_large"
      }
    },
    "rate_limit": {
      "mode": "enabled",
      "owner": "bff",
      "status": 429,
      "error_code": "rate_limited",
      "algorithm": "token_bucket",
      "scopes": [
        {
          "name": "per_client_ip",
          "key_fields": [
            "runtime.client_ip"
          ],
          "bucket": {
            "capacity": 120,
            "refill_per_second": 2
          },
          "on_exceed": {
            "action": "reject",
            "retry_after_seconds": 1
          }
        }
      ],
      "observability": {
        "on_exceed": {
          "error_class": "overload",
          "fault_domain": "bff",
          "emit_event": "rate_limited",
          "log_fields": [
            "client_ip",
            "route",
            "method"
          ]
        }
      }
    }
  }
}