{
  "spec_version": 1,
  "breaking_change": false,
  "effective_from": "2026-02-02",
  "boundary": "bff_to_gateway",
  "deployment": {
    "bff": "cloudflare_workers",
    "gateway": "cloudflare_workers"
  },
  "http": {
    "rpc_style": "json_rpc_over_http",
    "routing": {
      "mode": "enabled",
      "api_prefix": "/internal",
      "rpc_endpoint": "/internal/rpc",
      "allowed_paths": [
        "/internal/rpc"
      ],
      "on_other_paths": {
        "action": "reject",
        "status": 404,
        "error_code": "not_found"
      }
    },
    "methods": {
      "allowed": [
        "POST",
        "OPTIONS"
      ],
      "state_changing": [
        "POST"
      ]
    },
    "content_types": {
      "accepted_request": [
        "application/json"
      ],
      "accepted_response": [
        "application/json"
      ],
      "require_json_on_methods": [
        "POST"
      ],
      "default_response": "application/json; charset=utf-8",
      "json_parsing": {
        "reject_invalid_json": true,
        "reject_bom": true,
        "reject_non_utf8": true
      }
    },
    "cache": {
      "response_cache_control": "no-store"
    },
    "csrf": {
      "mode": "disabled"
    },
    "contract_version": {
      "mode": "required",
      "header": "x-contract-version",
      "accepted": {
        "mode": "explicit_list",
        "items": [
          "1"
        ]
      },
      "on_missing": {
        "action": "reject",
        "status": 400,
        "error_code": "contract_version_required"
      }
    },
    "idempotency": {
      "mode": "validate_only",
      "validate_only": {
        "require_header_when_state_changing": true,
        "on_missing_key": {
          "action": "reject",
          "status": 400,
          "error_code": "idempotency_key_required"
        }
      },
      "fingerprint": {
        "include": [
          "claims.tenant_id",
          "claims.actor.actor_id",
          "route.service",
          "route.resource",
          "route.property",
          "route.operation",
          "x-idempotency-key",
          "body_hash"
        ],
        "body_hash": {
          "algorithm": "sha256",
          "input": {
            "type": "request_body",
            "encoding": {
              "type": "canonical_json",
              "rules": {
                "object_member_order": "sort_keys",
                "omit_insignificant_whitespace": true,
                "string_encoding": "utf-8",
                "number_representation": "normalized_json_number",
                "array_order": "preserve"
              }
            }
          },
          "only_for_content_types": [
            "application/json"
          ],
          "on_other_content_types": {
            "type": "raw_bytes"
          },
          "max_body_bytes_to_hash": 10485760,
          "on_body_too_large": {
            "action": "reject",
            "status": 413,
            "error_code": "idempotency_body_too_large_to_hash"
          }
        }
      }
    },
    "retry": {
      "mode": "enabled",
      "apply_to_methods": [
        "POST"
      ],
      "max_attempts": 2,
      "retry_on_status": [
        502,
        503,
        504
      ],
      "retry_on_network_error": true,
      "backoff_ms": [
        0,
        200
      ],
      "retry_gate": {
        "require_idempotency_key_when_state_changing": true
      }
    },
    "errors": {
      "defaults": {
        "default_status": 502
      },
      "propagation": {
        "always_use_error_shape": true,
        "algorithm": "preserve_then_map_then_shape",
        "preserve_status_for": [
          400,
          401,
          403,
          404,
          409,
          413,
          415,
          422,
          429,
          431,
          503
        ],
        "map_4xx_to": 502,
        "map_5xx_to": 502,
        "network_error_to": 502
      }
    },
    "timeouts": {
      "upstream_timeout_ms": 3800
    }
  },
  "auth": {
    "transport": "bearer",
    "token_profile": {
      "type": "jwt",
      "allowed_algs": [
        "RS256"
      ],
      "issuer": "bff",
      "audience": "gateway",
      "jwks": {
        "source": "env",
        "env_var": "JWT_JWKS_JSON",
        "cache_ttl_sec": 300
      },
      "max_clock_skew_sec": 30,
      "required_claims": [
        "iss",
        "aud",
        "exp",
        "sub",
        "tenant_id",
        "actor.actor_id",
        "scopes",
        "roles"
      ]
    },
    "require_authorization_header": true,
    "allow_cookie": false,
    "bff_outbound_to_gateway": {
      "mode": "bearer",
      "authorization_header": "authorization",
      "token": {
        "type": "access_token",
        "issuer": "bff",
        "source": "runtime_issued"
      }
    },
    "gateway_inbound_verification": {
      "authorization_header": "authorization",
      "checks": [
        "verify_signature",
        "verify_issuer",
        "verify_audience",
        "verify_expiration",
        "verify_scopes_roles_as_needed"
      ],
      "on_fail": {
        "action": "reject",
        "status": 401,
        "error_code": "unauthorized"
      },
      "on_success": {
        "use_only_decoded_claims": true,
        "reject_alternative_identity_headers": true
      }
    }
  },
  "headers": {
    "pipeline_order": [
      "normalize",
      "drop_hop_by_hop",
      "explicit_drop",
      "allow",
      "default_drop"
    ],
    "normalize": {
      "mode": "lowercase"
    },
    "duplicates": {
      "mode": "reject",
      "reject_status": 400,
      "allow_multiple": [
        "set-cookie"
      ]
    },
    "drop_default": {
      "mode": "allowlist",
      "if_not_in_allow_or_passthrough": "drop"
    },
    "drop_hop_by_hop": [
      "connection",
      "keep-alive",
      "proxy-authenticate",
      "proxy-authorization",
      "te",
      "trailer",
      "transfer-encoding",
      "upgrade"
    ],
    "requirements": {
      "inbound_must_include": [
        "x-contract-version",
        "x-request-id"
      ],
      "outbound_must_include": [
        "x-contract-version",
        "x-request-id"
      ]
    },
    "bff_outbound": {
      "drop": [
        "set-cookie",
        "cookie",
        "origin",
        "referer",
        "user-agent",
        "x-forwarded-for",
        "x-real-ip",
        "cf-connecting-ip",
        "cf-ray",
        "x-amzn-trace-id",
        "forwarded"
      ],
      "allow": [
        "content-type",
        "authorization",
        "traceparent",
        "x-contract-version",
        "x-request-id",
        "x-trace-debug",
        "x-idempotency-key"
      ]
    },
    "gateway_inbound": {
      "drop": [
        "cookie",
        "origin",
        "referer",
        "user-agent",
        "x-forwarded-for",
        "x-real-ip",
        "cf-connecting-ip",
        "cf-ray",
        "x-amzn-trace-id",
        "forwarded"
      ],
      "allow": [
        "content-type",
        "authorization",
        "traceparent",
        "x-request-id",
        "x-idempotency-key",
        "x-contract-version",
        "x-trace-debug"
      ],
      "forbidden_identity_headers": [
        "x-actor",
        "x-actor-sig",
        "x-actor-sub",
        "x-actor-provider",
        "x-actor-tenant-id",
        "x-actor-roles",
        "x-actor-scopes"
      ]
    }
  },
  "observability": {
    "mode": "enabled",
    "error_classification": {
      "mode": "enabled",
      "log_only": true,
      "required_fields": [
        "error_class",
        "fault_domain"
      ],
      "allowed_error_class": [
        "validation",
        "authn",
        "authz",
        "timeout",
        "upstream",
        "network",
        "bug",
        "overload"
      ],
      "allowed_fault_domain": [
        "front",
        "bff",
        "gateway",
        "adapter",
        "external"
      ]
    },
    "events": [
      "authn_verified",
      "authn_rejected",
      "route_not_found"
    ],
    "log_fields": {
      "required_additional_fields": [
        "rpc_style",
        "rpc_method"
      ],
      "optional_additional_fields": [
        "tenant_id",
        "actor_id",
        "authz_result"
      ]
    },
    "request_id": {
      "header": "x-request-id",
      "requirement_timing": "pre_processing",
      "generation": {
        "mode": "disabled"
      },
      "propagation": {
        "passthrough": true,
        "outbound_must_include": true
      }
    },
    "trace_context": {
      "traceparent": {
        "header": "traceparent",
        "propagation": "passthrough",
        "generate_if_missing": false
      }
    },
    "redaction": {
      "drop_headers": [
        "authorization",
        "cookie",
        "set-cookie"
      ],
      "redact_headers": [
        "x-idempotency-key"
      ],
      "redact_fields": [
        "email",
        "display_name"
      ],
      "redact_strategy": {
        "default": "hash",
        "hash_algorithm": "sha256",
        "salt_source": "deployment_secret"
      }
    },
    "sampling": {
      "logging": {
        "default_sample_rate": 1,
        "error_sample_rate": 1
      },
      "tracing": {
        "default_sample_rate": 0.1,
        "error_sample_rate": 1,
        "force_sample_if_header_present": "x-trace-debug"
      }
    }
  },
  "limits": {
    "header": {
      "max_request_header_bytes": 16384,
      "on_exceed": {
        "action": "reject",
        "status": 431,
        "error_code": "request_header_fields_too_large"
      }
    },
    "body": {
      "max_request_body_bytes": 10485760,
      "max_response_body_bytes": 5242880,
      "on_exceed": {
        "action": "reject",
        "status": 413,
        "error_code": "payload_too_large"
      }
    },
    "concurrency": {
      "max_concurrency": 8,
      "scope": "per_instance",
      "queueing": {
        "enabled": true,
        "max_queue_length": 256,
        "on_exceed": {
          "action": "reject",
          "status": 503,
          "error_code": "server_overloaded"
        }
      }
    }
  }
}